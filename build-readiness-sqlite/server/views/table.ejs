<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Build Readiness - <%= releaseId %>
  </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/public/styles.css">
</head>

<body class="bg-gray-50">
  <div class="container mx-auto px-4 py-6 max-w-full">

    <!-- Sticky Header -->
    <div class="sticky-header bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl font-bold text-gray-900">Release: <%= releaseId %>
        </h1>
        <a href="/" class="text-blue-600 hover:text-blue-800 text-sm">← Home</a>
      </div>

      <% if (rows.length> 0) { %>
        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
          <div class="bg-blue-50 rounded-lg p-3">
            <div class="text-sm text-gray-600">Total Items</div>
            <div class="text-2xl font-bold text-blue-700">
              <%= counts.total %>
            </div>
          </div>
          <div class="bg-green-50 rounded-lg p-3">
            <div class="text-sm text-gray-600">PBIs</div>
            <div class="text-2xl font-bold text-green-700">
              <%= counts.pbiCount %>
            </div>
          </div>
          <div class="bg-yellow-50 rounded-lg p-3">
            <div class="text-sm text-gray-600">Bugs</div>
            <div class="text-2xl font-bold text-yellow-700">
              <%= counts.bugCount %>
            </div>
          </div>
          <div class="bg-purple-50 rounded-lg p-3">
            <div class="text-sm text-gray-600">Full Score</div>
            <div class="text-2xl font-bold text-purple-700">
              <%= counts.fullScoreCount %>
            </div>
          </div>
          <div class="bg-indigo-50 rounded-lg p-3">
            <div class="text-sm text-gray-600">% Complete</div>
            <div class="text-2xl font-bold text-indigo-700">
              <%= counts.fullScorePercent %>%
            </div>
          </div>
        </div>

        <!-- Search and Actions -->
        <div class="flex flex-col md:flex-row gap-3">
          <input type="text" id="searchInput" placeholder="Search by title, type, state, or tags..."
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <button onclick="copyToClipboard('csv')"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
            Copy CSV
          </button>
          <button onclick="copyToClipboard('tsv')"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
            Copy TSV
          </button>
        </div>
        <% } %>
    </div>

    <% if (rows.length===0) { %>
      <!-- Empty State -->
      <div class="empty-state bg-white rounded-lg shadow-md p-12">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">No Data Yet</h2>
        <p class="text-gray-600 mb-6">
          This release has no build readiness data. Send data via the ingest API:
        </p>
        <div class="code-block">
          $headers = @{<br>
          &nbsp;&nbsp;"Authorization" = "Bearer <%= authToken %>"<br>
            &nbsp;&nbsp;"Content-Type" = "application/json"<br>
            }<br>
            <br>
            $body = @(<br>
            &nbsp;&nbsp;@{<br>
            &nbsp;&nbsp;&nbsp;&nbsp;release_id = "<%= releaseId %>"<br>
              &nbsp;&nbsp;&nbsp;&nbsp;id = 12345<br>
              &nbsp;&nbsp;&nbsp;&nbsp;type = "PBI"<br>
              &nbsp;&nbsp;&nbsp;&nbsp;title = "Sample Work Item"<br>
              &nbsp;&nbsp;&nbsp;&nbsp;state = "Done"<br>
              &nbsp;&nbsp;&nbsp;&nbsp;score = "6/6"<br>
              &nbsp;&nbsp;&nbsp;&nbsp;devNotes = "Implementation notes"<br>
              &nbsp;&nbsp;&nbsp;&nbsp;qaNotes = "Test results"<br>
              &nbsp;&nbsp;}<br>
              ) | ConvertTo-Json<br>
              <br>
              Invoke-RestMethod -Uri "http://127.0.0.1:<%= port %>/api/ingest" `<br>
                &nbsp;&nbsp;-Method POST -Headers $headers -Body $body
        </div>
      </div>
      <% } else { %>
        <!-- Data Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="table-container">
            <table id="dataTable">
              <thead>
                <tr>
                  <th class="text-left w-8"></th>
                  <th class="text-left">WI</th>
                  <th class="text-left">Type</th>
                  <th class="text-left">Title</th>
                  <th class="text-left">State</th>
                  <th class="text-center">Score</th>
                  <th class="text-left">Missing</th>
                  <th class="text-center">DevNotes?</th>
                  <th class="text-center">QANotes?</th>
                  <th class="text-left">Tags</th>
                  <th class="text-left">Review</th>
                </tr>
              </thead>
              <tbody>
                <% rows.forEach(function(row, index) { %>
                  <tr class="data-row cursor-pointer hover:bg-blue-50"
                    data-search="<%= [row.title, row.wi_type, row.state, row.tags || ''].join(' ').toLowerCase() %>"
                    data-details-id="details-<%= index %>">
                    <td class="text-center">
                      <span class="expand-icon text-gray-500">▶</span>
                    </td>
                    <td>
                      <%= row.wi_id %>
                    </td>
                    <td>
                      <%= row.wi_type %>
                    </td>
                    <td class="max-w-md truncate" title="<%= row.title %>">
                      <%= row.title %>
                    </td>
                    <td>
                      <%= row.state %>
                    </td>
                    <td class="text-center">
                      <% if (row.score) { %>
                        <span
                          class="<%= row.score.match(/^(\d+)\/\1$/) ? 'text-green-600 font-semibold' : 'text-gray-600' %>">
                          <%= row.score %>
                        </span>
                        <% } else { %>
                          <span class="text-gray-400">-</span>
                          <% } %>
                    </td>
                    <td class="text-sm text-gray-600">
                      <%= row.missing || '-' %>
                    </td>
                    <td class="text-center">
                      <% if (row.dev_notes) { %>
                        <span class="checkmark">✓</span>
                        <% } else { %>
                          <span class="text-gray-300">-</span>
                          <% } %>
                    </td>
                    <td class="text-center">
                      <% if (row.qa_notes) { %>
                        <span class="checkmark">✓</span>
                        <% } else { %>
                          <span class="text-gray-300">-</span>
                          <% } %>
                    </td>
                    <td class="text-sm text-gray-600">
                      <%= row.tags || '-' %>
                    </td>
                    <td class="text-sm">
                      <% if (row.review_evidence) { %>
                        <span class="px-2 py-1 rounded text-xs font-medium <%= 
                        row.review_evidence === 'Field' ? 'bg-blue-100 text-blue-800' :
                        row.review_evidence === 'Relation' ? 'bg-green-100 text-green-800' :
                        'bg-gray-100 text-gray-800' 
                      %>">
                          <%= row.review_evidence %>
                        </span>
                        <% } else { %>
                          <span class="text-gray-400">-</span>
                          <% } %>
                    </td>
                  </tr>
                  <!-- Expandable Details Row -->
                  <tr id="details-<%= index %>" class="details-row" style="display: none;">
                    <td colspan="11" class="bg-gray-50 p-4">
                      <div class="grid grid-cols-1 gap-4 text-sm">
                        <% if (row.acceptance_criteria) { %>
                          <div>
                            <strong class="text-blue-700">Acceptance Criteria:</strong>
                            <div class="mt-1 p-2 bg-white rounded border">
                              <%= row.acceptance_criteria %>
                            </div>
                          </div>
                          <% } %>
                            <% if (row.description) { %>
                              <div>
                                <strong class="text-blue-700">Description:</strong>
                                <div class="mt-1 p-2 bg-white rounded border">
                                  <%= row.description %>
                                </div>
                              </div>
                              <% } %>
                                <% if (row.dev_notes) { %>
                                  <div>
                                    <strong class="text-green-700">Dev Notes:</strong>
                                    <div class="mt-1 p-2 bg-white rounded border">
                                      <%= row.dev_notes %>
                                    </div>
                                  </div>
                                  <% } %>
                                    <% if (row.qa_notes) { %>
                                      <div>
                                        <strong class="text-purple-700">QA Notes:</strong>
                                        <div class="mt-1 p-2 bg-white rounded border">
                                          <%= row.qa_notes %>
                                        </div>
                                      </div>
                                      <% } %>
                                        <% if (!row.acceptance_criteria && !row.description && !row.dev_notes &&
                                          !row.qa_notes) { %>
                                          <div class="text-gray-500 italic">No additional details available</div>
                                          <% } %>
                      </div>
                    </td>
                  </tr>
                  <% }); %>
              </tbody>
            </table>
          </div>
        </div>
        <% } %>

  </div>

  <script>
    // Toggle expandable row details
    function toggleRow(detailsId) {
      console.log('Toggling row:', detailsId);
      const detailsRow = document.getElementById(detailsId);

      if (!detailsRow) {
        console.error('Details row not found:', detailsId);
        return;
      }

      const parentRow = detailsRow.previousElementSibling;
      const icon = parentRow ? parentRow.querySelector('.expand-icon') : null;

      const isHidden = detailsRow.style.display === 'none' || !detailsRow.style.display;

      if (isHidden) {
        detailsRow.style.display = 'table-row';
        if (icon) {
          icon.textContent = '▼';
          icon.classList.add('text-blue-600');
          icon.classList.remove('text-gray-500');
        }
      } else {
        detailsRow.style.display = 'none';
        if (icon) {
          icon.textContent = '▶';
          icon.classList.add('text-gray-500');
          icon.classList.remove('text-blue-600');
        }
      }
    }

    // Attach click handlers to all data rows (CSP-compliant)
    document.addEventListener('DOMContentLoaded', function () {
      const dataRows = document.querySelectorAll('.data-row');
      dataRows.forEach(row => {
        row.addEventListener('click', function () {
          const detailsId = this.getAttribute('data-details-id');
          if (detailsId) {
            toggleRow(detailsId);
          }
        });
      });
    });

    // Client-side search filter
    const searchInput = document.getElementById('searchInput');
    const dataRows = document.querySelectorAll('.data-row');

    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        dataRows.forEach(row => {
          const searchText = row.getAttribute('data-search');
          const detailsRow = row.nextElementSibling;

          if (searchText.includes(query)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
            // Hide details row if parent is hidden
            if (detailsRow && detailsRow.classList.contains('details-row')) {
              detailsRow.style.display = 'none';
              const icon = row.querySelector('.expand-icon');
              if (icon) {
                icon.textContent = '▶';
                icon.classList.add('text-gray-500');
                icon.classList.remove('text-blue-600');
              }
            }
          }
        });
      });
    }

    // Copy visible rows to clipboard
    function copyToClipboard(format) {
      const delimiter = format === 'csv' ? ',' : '\t';
      const headers = ['WI', 'Type', 'Title', 'State', 'Score', 'Missing', 'DevNotes', 'QANotes', 'Tags', 'Review'];

      let output = headers.join(delimiter) + '\n';

      const visibleRows = Array.from(document.querySelectorAll('.data-row'))
        .filter(row => row.style.display !== 'none');

      visibleRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = Array.from(cells).map(cell => {
          let text = cell.textContent.trim();
          // Escape commas for CSV
          if (format === 'csv' && text.includes(',')) {
            text = `"${text}"`;
          }
          return text;
        });
        output += rowData.join(delimiter) + '\n';
      });

      navigator.clipboard.writeText(output).then(() => {
        alert(`Copied ${visibleRows.length} rows as ${format.toUpperCase()}`);
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('Failed to copy to clipboard');
      });
    }
  </script>
</body>

</html>